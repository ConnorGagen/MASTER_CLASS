---
title: "03_analysis_all_time_points"
author: "JR"
date: "2024-07-14"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading counts matrix raw input from Salmon (see pipeline documentation)
```{r loading counts objects}

#IMPORTANT Raw counts file
counts_matrix <- read.table("/scratch/Shares/rinnclass/MASTER_CLASS/lessons/04_RNAseq_Dox/01_Mouse_dox_wt/good_class_RNAseq/pipeline_output/star_salmon/salmon.merged.gene_counts.tsv", header=TRUE, row.names=1)

```

# 1 IMPORTANT : CREATE Gene name to gene id conversion table.
This will archive all genes in the starting analysis 
# Note this would only change upon a different genome annotation as input into NF_CORE RNAseq pipeline
```{r}

# Note making data frame from index other files
g2s <- data.frame(
  gene_id = rownames(counts_matrix),
  gene_name = counts_matrix[, 1]
)
view(g2s)

```

# 2 Now that g2s is made let's clean up our counts matrix
```{r}
# remove gene_name column

counts_matrix <- counts_matrix[,-1]

# Round counts to integer mode required for DESEQ2
counts_integer <- round(counts_matrix)
View(counts_matrix)
View(counts_integer)

```

# Loading Deseq_sample_sheet
```{r}
load("../05_RNAseq_in_R_studio/results/deseq_samples.RData", verbose = T)

# oops that loaded a count matrix that isn't in integer -let's fix that
counts_integer <- round(counts_matrix)

```

# 3) Factor Samples (just in case - double check if already factored)
```{r}

deseq_samples$time_point <- factor(deseq_samples$time_point)
deseq_samples$replicate <- factor(deseq_samples$replicate)

```

# 4) Make sure rows and columns are ordered for analysis
```{r}


# Check ordering
  stopifnot(all(colnames(counts_integer) == rownames(deseq_samples$sample_id)))

# Nice our columns in the counts are the same as rows in sample_id

```


# 4) Run Deseq Model (time_point)
```{r}

dds_time_point <- DESeqDataSetFromMatrix(countData = counts_integer,
                              colData = deseq_samples,
                              design = ~ time_point)

dds_time_point <- DESeq(dds_time_point)

```

# 5 Compile all results 0-vs-12, 0-vs-24, 0-vs-48, 0-vs-96
First we are going to make a datframe structure to store the results
# Note this is a common strategy before a for-loop : make file to populate

```{r}

# Let's find the names of the results we want
result_names <- resultsNames(dds_time_point)
view(result_names)
# Let's get rid of intercept
results_names <- result_names[-1]

# Now the empty data frame with values we want to grab from results

res_df <- data.frame("gene_id" = character(), 
                     "baseMean" = numeric(), 
                     "log2FoldChange" = numeric(), 
                     "lfcSE" = numeric(),
                     "stat" = numeric(),
                     "pvalue" = numeric(),
                     "padj" = numeric(),
                     "gene_name" = character(),
                     "result_name" = character())


view(res_df)

```

# 6 FOR-LOOP: for-loop to put the values for each time point analysis
```{r}
# Let's figure out each step - for loops are common practice so let's get to know them

for(i in 1:length(results_names)) {
  results_name <- results_names[i]
  res <- results(dds_time_point, name = results_name)
  tmp_res_df <- res %>% 
    as.data.frame() %>%
    rownames_to_column("gene_id") %>%
    merge(g2s) %>%
    mutate(result_name = results_name)
  res_df <- bind_rows(res_df, tmp_res_df)
  
}

  # Checking NAs
  sum(is.na(res_df$padj))

```

# saving results in res_df
```{r}
save(res_df, file = "results/time_point_res_df.RData")
```

# Nice we have all our results now let's go over what it all means :) !
The key information we have is column:
Basemean: a measure of how much the gene was expressed
Log2FoldChange: how much the gene went up or down in a given comparison of time
Lfsce: shrunken log fold change
# https://hbctraining.github.io/DGE_workshop/lessons/05_DGE_DESeq2_analysis2.html#:~:text=Shrunken%20log2%20foldchanges%20(LFC),High%20dispersion%20values
Pvalue
Padj : adjusted pval (what we will be using)
result_name: this allows to have the values for each time point comparison tracked

########## ExceRcise #########
# Explore your results 
Which gene has the lowest padj
Which gene has the highest fold change
What are these genes?








