---
title: "FULL_RUN_TEST_2"
author: "JR"
date: "2024-07-09"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# load data so on same page
```{r}

load("/scratch/Shares/rinnclass/MASTER_CLASS/lessons/05_RNAseq_in_R_studio/results/deseq_samples.RData", verbose = T)

# NOte the write over for counts matrix and ordering of loading these two objects
load("/scratch/Shares/rinnclass/MASTER_CLASS/lessons/05_RNAseq_in_R_studio/results/count_files.RData", verbose = T)

```



# Making timepoint DDS

```{r}
dds_lrt <- DESeqDataSetFromMatrix(countData = counts_filtered,
                              colData = deseq_samples,
                              design = ~ time_point + replicate)

dds_lrt <- DESeq(dds_lrt)
```


# Towards more complete protocol
# Loading in files : provide path to Firre data used
```{r}
# /scratch/Shares/rinnclass/MASTER_CLASS/lessons/05_RNAseq_in_R_studio/results
load("../05_RNAseq_in_R_studio/results/deseq_samples.RData", verbose = T)

# NOte the write over for counts matrix and ordering of loading these two objects
load("../05_RNAseq_in_R_studio/results/count_files.RData", verbose = T)
```

# Deseq model - please repeat all below for LRT and wald
```{r}
dds <- DESeqDataSetFromMatrix(countData = counts_filtered,
                              colData = deseq_samples,
                              design = ~ time_point)

dds <- DESeq(dds)
```

# Curating all results into data frame
# Repeat this process for all DESEQ2 models (batch, wald etc)
```{r}

resultsNames(dds)

result_names <- resultsNames(dds)

results_names <- result_names[-1]

res_df <- data.frame("gene_id" = character(), 
                     "baseMean" = numeric(), 
                     "log2FoldChange" = numeric(), 
                     "lfcSE" = numeric(),
                     "stat" = numeric(),
                     "pvalue" = numeric(),
                     "padj" = numeric(),
                     "gene_name" = character(),
                     "result_name" = character())




# For loop to get all results per time point  

for(i in 1:length(results_names)) {
  results_name <- results_names[i]
  res <- results(dds, name = results_name)
  tmp_res_df <- res %>% as.data.frame() %>%
    rownames_to_column("gene_id") %>%
    merge(g2s) %>%
    mutate(result_name = results_name)
  res_df <- bind_rows(res_df, tmp_res_df)
  
  # Checking NAs
  sum(is.na(res_df$padj))
  
  #TODO clean out NAs?

}
```

# Filter significant

```{r}

filtered_res_df <- res_df %>%
  filter(padj < 0.05, abs(log2FoldChange) > 1)

```

# Connect sig genes to counts for further analysis

```{r}


#TODO discuss rlog counts vs counts vs Tpm
# TODO produce all necessary files for any down stream analysis 
```

# Counts table for plotting in line plot
```{r}
#TODO counts/TPM table merge to plot time course as line plot
#TODO merging counts table to compare sig vs non sig genes time course changes

```

# Heatmap
```{r}
#TODO Counts/rlog counts merge to plot sig genes on heatmap
# TODO compare heat map of sig and nonsig genes in same heat map



```


# Downstream analysis
```{r}

#TODO All genes that continiously go up or down across time



```


# Zach function
```{r}

#TODO : results funciton not called to get res

# Set P val and threshold
p <- 0.05
foldchange <- 1.5

res_to_signif_tbl <- function(res, countdata, p = 0.05, foldchange = 1.5) {
  res_signif <- res %>%
    subset(padj < p & abs(log2FoldChange) > log2(foldchange))
  count_signif <- countdata %>% subset(rownames(.) %in% rownames(res_signif))
  signif_tbl <- tibble(count_signif) %>% mutate(gene = rownames(count_signif))
  return(list(res_signif, signif_tbl))
}

res <- results(dds)
res_lrt <-results(dds_lrt)

res_to_signif_tbl(res, counts_filtered, p = 0.05, foldchange = 1.5)
# 300 genes

res_to_signif_tbl(res_lrt, counts_filtered, p = 0.05, foldchange = 1.5)



res_df <- data.frame(res)

filtered_res <- res_df %>%
  filter(padj < 0.05, abs(log2FoldChange) > .6)


```


```{r}

```

